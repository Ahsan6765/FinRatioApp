const axios = require('axios');
const cheerio = require('cheerio');
const Parser = require('rss-parser');
const rssParser = new Parser();

class NewsService {
    constructor() {
        this.cache = new Map();
        this.cacheDuration = 15 * 60 * 1000; // 15 minutes cache
        this.rateLimits = new Map();
        this.maxRequestsPerMinute = 10;

        // RSS feed URLs
        this.rssSources = {
            // Google News RSS feeds for financial news
            googleNewsFinance: 'https://news.google.com/rss/search?q=finance+market+stocks&hl=en-US&gl=US&ceid=US:en',
            // Yahoo Finance RSS feed
            yahooFinanceRSS: 'https://finance.yahoo.com/news/rssindex',
            // General Google News top stories
            googleNewsTop: 'https://news.google.com/news/rss?hl=en-US&gl=US&ceid=US:en'
        };

        this.googleNews = {
            top: 'https://news.google.com/rss?hl=en-US&gl=US&ceid=US:en',
            searchBase: 'https://news.google.com/rss/search?q='
        };
    }

    checkRateLimit(source) {
        const now = Date.now();
        const oneMinuteAgo = now - 60000;
        
        // Initialize or clean up old requests
        if (!this.rateLimits.has(source)) {
            this.rateLimits.set(source, []);
        }
        
        let requests = this.rateLimits.get(source);
        requests = requests.filter(time => time > oneMinuteAgo);
        
        if (requests.length >= this.maxRequestsPerMinute) {
            throw new Error(`Rate limit exceeded for ${source}`);
        }
        
        requests.push(now);
        this.rateLimits.set(source, requests);
    }

    calculateRelevanceScore(article, query) {
        let score = 0;
        const queryTerms = query ? query.toLowerCase().split(/\s+/) : [];
        const content = (article.title + ' ' + article.description).toLowerCase();

        // Term frequency scoring
        queryTerms.forEach(term => {
            const regex = new RegExp(term, 'g');
            const matches = content.match(regex);
            if (matches) {
                score += matches.length;
            }
        });

        // Recency scoring (newer articles score higher)
        const age = Date.now() - new Date(article.publishedAt).getTime();
        const recencyScore = Math.max(0, 1 - (age / (24 * 60 * 60 * 1000))); // Full score if less than 24h old
        score += recencyScore * 3;

        // Source credibility scoring
        const credibilityScores = {
            'Reuters': 5,
            'MarketWatch': 4,
            'Yahoo Finance': 4,
            'Seeking Alpha': 3,
            'Investing.com': 3
        };
        score += credibilityScores[article.source] || 1;

        // Content length scoring
        score += Math.min(content.length / 1000, 2); // Up to 2 points for length

        return score;
    }

    async getFinancialNews(query) {
        const cacheKey = `news-${query}`;
        
        // Check cache first
        if (this.cache.has(cacheKey)) {
            const cachedData = this.cache.get(cacheKey);
            if (Date.now() - cachedData.timestamp < this.cacheDuration) {
                return cachedData.data;
            }
            this.cache.delete(cacheKey);
        }

        try {
            const newsData = {
                articles: []
            };

            // Prioritize Google News RSS as it's more reliable
            try {
                this.checkRateLimit('Google News');
                const googleNews = await this.scrapeGoogleNews(query);
                if (googleNews.length > 0) {
                    newsData.articles.push(...googleNews);
                }
            
            // Google News RSS (primary source)
            try {
                this.checkRateLimit('Google News');
                const googleNews = await this.scrapeGoogleNews(query);
                if (googleNews.length > 0) {
                    console.log('Successfully fetched Google News articles:', googleNews.length);
                    newsData.articles.push(...googleNews);
                }
            } catch (error) {
                console.error('Error fetching Google News RSS:', error.message);
                // If Google News fails, try Yahoo Finance as backup
                try {
                    this.checkRateLimit('Yahoo Finance');
                    const yahooNews = await this.scrapeYahooFinance();
                    if (yahooNews.length > 0) {
                        console.log('Successfully fetched Yahoo Finance articles:', yahooNews.length);
                        newsData.articles.push(...yahooNews);
                    }
                } catch (yahooError) {
                    console.error('Error fetching Yahoo Finance news:', yahooError.message);
                }
            }

            // Ensure we have at least some articles
            if (newsData.articles.length === 0) {
                throw new Error('No news articles could be fetched from any source');
            }

            // Remove duplicates based on title similarity
            newsData.articles = this.removeDuplicates(newsData.articles);

            // Calculate relevance scores and filter/sort based on query
            newsData.articles = newsData.articles.map(article => ({
                ...article,
                relevanceScore: this.calculateRelevanceScore(article, query)
            }));

            // Filter by query if provided
            if (query) {
                const queryLower = query.toLowerCase();
                newsData.articles = newsData.articles.filter(article => 
                    article.title.toLowerCase().includes(queryLower) ||
                    article.description.toLowerCase().includes(queryLower)
                );
            }

            // Sort by relevance score and date
            newsData.articles.sort((a, b) => {
                if (Math.abs(b.relevanceScore - a.relevanceScore) > 0.5) {
                    return b.relevanceScore - a.relevanceScore;
                }
                return new Date(b.publishedAt) - new Date(a.publishedAt);
            });

            // Cache the results
            this.cache.set(cacheKey, {
                timestamp: Date.now(),
                data: newsData
            });

            return newsData;
        } catch (error) {
            console.error('Error fetching news:', error);
            throw new Error('Failed to fetch news data');
        }
    }

    async scrapeMarketWatch() {
        try {
            const response = await axios.get(this.sources.marketWatch);
            const $ = cheerio.load(response.data);
            const articles = [];

            $('.article__content').each((i, elem) => {
                const title = $(elem).find('.article__headline').text().trim();
                const description = $(elem).find('.article__summary').text().trim();
                const url = $(elem).find('a').attr('href');
                const publishedAt = new Date().toISOString(); // Use current date as fallback

                if (title && description) {
                    articles.push({
                        title,
                        description,
                        url,
                        publishedAt,
                        source: 'MarketWatch'
                    });
                }
            });

            return articles;
        } catch (error) {
            console.error('Error scraping MarketWatch:', error);
            return [];
        }
    }

    async scrapeGoogleNews(query) {
        try {
            // If query provided, use search RSS; otherwise use top headlines
            let url = this.googleNews.top;
            if (query) {
                const q = encodeURIComponent(query + ' financial OR market OR stocks');
                url = `${this.googleNews.searchBase}${q}&hl=en-US&gl=US&ceid=US:en`;
            }

            const response = await axios.get(url, {
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                    'Accept-Language': 'en-US,en;q=0.5',
                    'Connection': 'keep-alive',
                    'Upgrade-Insecure-Requests': '1'
                },
                timeout: 10000
            });
            
            // Parse RSS XML using cheerio in XML mode
            const $ = cheerio.load(response.data, { xmlMode: true });
            const items = [];

            $('item').each((i, elem) => {
                const title = $(elem).find('title').text().trim();
                const link = $(elem).find('link').text().trim();
                const description = $(elem).find('description').text().trim();
                const pubDate = $(elem).find('pubDate').text().trim();
                const source = $(elem).find('source').text().trim() || 'Google News';

                if (title) {
                    items.push({
                        title,
                        description,
                        url: link,
                        publishedAt: pubDate || new Date().toISOString(),
                        source
                    });
                }
            });

            return items;
        } catch (error) {
            console.error('Error scraping Google News RSS:', error.message || error);
            return [];
        }
    }

    async scrapeYahooFinance() {
        try {
            const response = await axios.get(this.sources.yahooFinance);
            const $ = cheerio.load(response.data);
            const articles = [];

            $('li.js-stream-content').each((i, elem) => {
                const title = $(elem).find('h3').text().trim();
                const description = $(elem).find('p').text().trim();
                const url = 'https://finance.yahoo.com' + $(elem).find('a').attr('href');
                const publishedAt = new Date().toISOString(); // Use current date as fallback

                if (title && description) {
                    articles.push({
                        title,
                        description,
                        url,
                        publishedAt,
                        source: 'Yahoo Finance'
                    });
                }
            });

            return articles;
        } catch (error) {
            console.error('Error scraping Yahoo Finance:', error);
            return [];
        }
    }

    async getCompanyNews(companySymbol) {
        return this.getFinancialNews(`${companySymbol} stock OR company news`);
    }

    async getSectorNews(sectorName) {
        return this.getFinancialNews(`${sectorName} sector market analysis`);
    }

    async getMarketNews() {
        return this.getFinancialNews('stock market financial news');
    }

    removeDuplicates(articles) {
        const seen = new Set();
        return articles.filter(article => {
            // Create a simplified version of the title for comparison
            const simplifiedTitle = article.title
                .toLowerCase()
                .replace(/[^\w\s]/g, '') // Remove punctuation
                .replace(/\s+/g, ' ')    // Normalize whitespace
                .trim();
            
            // Calculate similarity with existing titles
            for (const existingTitle of seen) {
                if (this.calculateStringSimilarity(existingTitle, simplifiedTitle) > 0.8) {
                    return false; // Skip this article as it's too similar to an existing one
                }
            }
            
            seen.add(simplifiedTitle);
            return true;
        });
    }

    calculateStringSimilarity(str1, str2) {
        // Implement Levenshtein distance for string similarity
        const track = Array(str2.length + 1).fill(null).map(() =>
            Array(str1.length + 1).fill(null));
        
        for (let i = 0; i <= str1.length; i += 1) {
            track[0][i] = i;
        }
        for (let j = 0; j <= str2.length; j += 1) {
            track[j][0] = j;
        }

        for (let j = 1; j <= str2.length; j += 1) {
            for (let i = 1; i <= str1.length; i += 1) {
                const indicator = str1[i - 1] === str2[j - 1] ? 0 : 1;
                track[j][i] = Math.min(
                    track[j][i - 1] + 1,
                    track[j - 1][i] + 1,
                    track[j - 1][i - 1] + indicator
                );
            }
        }

        // Convert distance to similarity score (0 to 1)
        const maxLength = Math.max(str1.length, str2.length);
        return 1 - (track[str2.length][str1.length] / maxLength);
    }
}

module.exports = new NewsService();